#checked 25/6/2019
import subprocess,os,sys
import json


try:
	dir_path = os.path.dirname(os.path.realpath(__file__))
	parent_dir_path = os.path.abspath(os.path.join(dir_path, os.pardir))
	sys.path.insert(0, parent_dir_path)

	from aidingScripts import generalVariables
	TestFailed = generalVariables.TestFailedToLaunch
	DeviceNotSecure= generalVariables.DeviceIsntSecure
	DeviceIsSecure= generalVariables.DeviceIsSecure
	TestNotApplicable = generalVariables.TestNotApplicable
	resultsDir = generalVariables.resultsDirWIFI
	temporaryFiles = generalVariables.temporaryFiles
	testsDir=generalVariables.testsDir	

except Exception as e:
	print(e)
	TestFailed =  "Test failed"
	DeviceNotSecure = "Vulnerable"
	DeviceIsSecure ="Not Vulnerable"
	TestNotApplicable ="Not Applicable"
	resultsDir ="results/WiFi"
	


######################## RECEIVE  PARAMTERS  ###########################
DeviceIP= sys.argv[1]
DeviceName=  sys.argv[2]
DeviceMAC=  sys.argv[3]

######################## TEST LAUNCHING SECTION  #######################

code = "Search for Exploits test"
print ("[Test Running]: " + code)
commands=DeviceName
if commands =="":
	commands="ABCDEFGHIJKLMNOPQSTXYZ"	

command="searchsploit -t -j " + commands
DetialedResult = None
SummaryResult = TestFailed
SummaryResult2 = "--"
try:
	resultsJson={}
	results=subprocess.check_output(command,shell=True,stderr=open(os.devnull, 'w'))
	try:
		resultsJson = json.loads(results)
	except Exception as e:
		if '\escape' in e.message: #sometimes the json file is ended with \n 
			results = results.replace('\\', "\\\\")
			resultsJson = json.loads(results)



	if "RESULTS_EXPLOIT" in resultsJson:
		if len(resultsJson["RESULTS_EXPLOIT"]):
			print("[Search Exploits]: Found [{}] possible exploits for device ".format(len(resultsJson["RESULTS_EXPLOIT"] ), DeviceName))
			counter = 0
			for exp in  resultsJson["RESULTS_EXPLOIT"]:
				print(exp["Title"])
				counter = counter + 1
				if counter == 3:
					print("...etc")
					break
			
			SummaryResult = DeviceNotSecure
			SummaryResult2 = "{} exploits found".format(len(resultsJson["RESULTS_EXPLOIT"]))		
			DetialedResult = resultsJson
			
		else:
			SummaryResult = DeviceIsSecure
			SummaryResult2 = "No exploits found"
			print ("[Search Exploits]: No exploits found")
			
except Exception as e:
	exc_type, exc_obj, exc_tb = sys.exc_info()
	print("Error [Line:{}]: {}".format( exc_tb.tb_lineno, str(e)))
	pass
	

######################## TEST OUTPUT SECTION ###########################
filePath= os.path.join(resultsDir,DeviceMAC,"SearchFrExploits_Summary" )
with open (filePath , "w") as fout: 
	fout.write(SummaryResult)		
	fout.write("\n")
	fout.write(SummaryResult2)

if DetialedResult:
	filePath= os.path.join(resultsDir,DeviceMAC,"SearchFrExploits_Detailed" )
	with open (filePath , "w") as fout: 	
		json.dump(DetialedResult, fout)
